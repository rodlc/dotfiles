# Network utilities
alias myip="curl https://ipinfo.io/json"
alias speedtest="curl -s https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py | python -"  # Ookla servers
alias fastcom="npx fast-cli"  # Netflix CDN (fast.com)

# Development server
alias serve='ruby -run -e httpd . -p 8000'

# Open current directory in Zed
alias z="zed ."

# Git wrapper â€” Alert if main is behind origin before checkout
git() {
  # Alerte avant checkout si main est en retard
  if [[ "$1" =~ ^(checkout|co|switch)$ ]]; then
    command git fetch --quiet 2>/dev/null
    local default_branch=$(command git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | cut -d'/' -f4)
    default_branch=${default_branch:-main}
    local behind=$(command git rev-list --count $default_branch..origin/$default_branch 2>/dev/null)
    [[ "$behind" -gt 0 ]] && echo "âš ï¸  \033[1;33m$default_branch\033[0m behind by \033[1;31m$behind\033[0m"
  fi
  command git "$@"
}

# Checkout main (passe par le wrapper â†’ alerte incluse)
gm() {
  git checkout "$(command git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | cut -d'/' -f4 || echo main)"
}

# Nettoyage branches (passe par le wrapper â†’ alerte incluse)
gcleanup() {
  local db=$(command git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | cut -d'/' -f4)
  db="${db:-main}"
  git checkout "$db" && git pull origin "$db" && git fetch -p && \
    command git branch --merged | grep -vE "^\*|$db" | xargs -n1 git branch -d
}

# Git worktree â€” Travailler sur plusieurs branches en parallÃ¨le
wt-new() {
  [[ -z "$1" ]] && echo "Usage: wt-new <branch>" && return 1
  local repo=$(basename "$(git rev-parse --show-toplevel)")
  local target="../${repo}-$1"
  git worktree add "$target" -b "$1" && echo "âœ… Worktree: $target" && cd "$target"
}

wt-from() {
  [[ -z "$1" ]] && echo "Usage: wt-from <existing-branch>" && return 1
  local repo=$(basename "$(git rev-parse --show-toplevel)")
  local target="../${repo}-$1"
  git worktree add "$target" "$1" && echo "âœ… Worktree: $target" && cd "$target"
}

wt-list() { git worktree list; }

wt-rm() {
  [[ -z "$1" ]] && echo "Usage: wt-rm <branch>" && return 1
  local repo=$(basename "$(git rev-parse --show-toplevel 2>/dev/null || git rev-parse --show-toplevel)")
  git worktree remove "../${repo}-$1" && echo "ğŸ—‘ï¸  Removed ${repo}-$1"
}

wt-clean() {
  git worktree list | tail -n +2 | awk '{print $1}' | while read wt; do
    git worktree remove "$wt" && echo "ğŸ—‘ï¸  Removed $wt"
  done
}
